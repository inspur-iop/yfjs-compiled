!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){function b(b){try{return!b||b instanceof a||(b=a(b)),a.support.boxSizing&&"border-box"===b.css("boxSizing")}catch(a){return!1}}a.fn.dragsort=function(c){if("destroy"==c)return void a(this.selector).trigger("dragsort-uninit");var d=a.extend({},a.fn.dragsort.defaults,c),e=[],f=null,g=null;return this.each(function(c,h){a(h).is("table")&&1==a(h).children().size()&&a(h).children().is("tbody")&&(h=a(h).children().get(0));var i={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:h,init:function(){d.tagName=0==a(this.container).children().size()?d.defaultSelector:a(this.container).children().get(0).tagName.toLowerCase(),""==d.itemSelector&&(d.itemSelector=d.tagName),""==d.dragSelector&&(d.dragSelector=d.tagName),""==d.placeHolderTemplate&&(d.placeHolderTemplate="<"+d.tagName+">&nbsp;</"+d.tagName+">"),a(this.container).attr("data-listidx",c).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var b=e[a(this).attr("data-listidx")];a(b.container).unbind("mousedown",b.grabItem).unbind("dragsort-uninit"),b.styleDragHandlers(!1)},getItems:function(){return a(this.container).children(d.itemSelector)},styleDragHandlers:function(b){this.getItems().map(function(){return a(this).is(d.dragSelector)?this:a(this).find(d.dragSelector).get()}).css("cursor",b?"pointer":"")},grabItem:function(b){var c=e[a(this).attr("data-listidx")],f=a(b.target).closest("[data-listidx] > "+d.tagName).get(0),g=c.getItems().filter(function(){return this==f}).size()>0;if(!(1!=b.which||a(b.target).is(d.dragSelectorExclude)||a(b.target).closest(d.dragSelectorExclude).size()>0)&&g){b.preventDefault();for(var h=b.target;!a(h).is(d.dragSelector);){if(h==this)return;h=h.parentNode}a(h).attr("data-cursor",a(h).css("cursor")),a(h).css("cursor","move");var i=this,j=function(){c.dragStart.call(i,b),a(c.container).unbind("mousemove",j)};a(c.container).mousemove(j).mouseup(function(){a(c.container).unbind("mousemove",j),a(h).css("cursor",a(h).attr("data-cursor"))})}},dragStart:function(c){null!=f&&null!=f.draggedItem&&f.dropItem(),f=e[a(this).attr("data-listidx")],f.draggedItem=a(c.target).closest("[data-listidx] > "+d.tagName),f.draggedItem.attr("data-origpos",a(this).attr("data-listidx")+"-"+a(f.container).children().index(f.draggedItem));var g=parseInt(f.draggedItem.css("marginTop")),h=parseInt(f.draggedItem.css("marginLeft"));if(f.offset=f.draggedItem.offset(),f.offset.top=c.pageY-f.offset.top+(isNaN(g)?0:g)-1,f.offset.left=c.pageX-f.offset.left+(isNaN(h)?0:h)-1,!d.dragBetween){var i=0==a(f.container).outerHeight()?Math.max(1,Math.round(.5+f.getItems().size()*f.draggedItem.outerWidth()/a(f.container).outerWidth()))*f.draggedItem.outerHeight():a(f.container).outerHeight();f.offsetLimit=a(f.container).offset(),f.offsetLimit.right=f.offsetLimit.left+a(f.container).outerWidth()-f.draggedItem.outerWidth(),f.offsetLimit.bottom=f.offsetLimit.top+i-f.draggedItem.outerHeight()}var j=b(f.draggedItem)?f.draggedItem.outerHeight():f.draggedItem.height(),k=b(f.draggedItem)?f.draggedItem.outerWidth():f.draggedItem.width();if("tr"==d.tagName?(f.draggedItem.children().each(function(){a(this).width(a(this).width())}),f.placeHolderItem=f.draggedItem.clone().attr("data-placeholder",!0),f.draggedItem.after(f.placeHolderItem),f.placeHolderItem.children().each(function(){a(this).css({borderWidth:0,width:a(this).width()+1,height:a(this).height()+1}).html("&nbsp;")})):(f.draggedItem.after(d.placeHolderTemplate),f.placeHolderItem=f.draggedItem.next().css({height:j,width:k}).attr("data-placeholder",!0)),"td"==d.tagName){var l=f.draggedItem.closest("table").get(0);a("<table id='"+l.id+"' style='border-width: 0px;' class='dragSortItem "+l.className+"'><tr></tr></table>").appendTo("body").children().append(f.draggedItem)}var m=f.draggedItem.attr("style");f.draggedItem.attr("data-origstyle",m?m:""),f.draggedItem.css({position:"absolute",opacity:.8,"z-index":d.dragZIndex,height:j,width:k}),f.scroll={moveX:0,moveY:0,maxX:a(document).width()-a(window).width(),maxY:a(document).height()-a(window).height()},f.scroll.scrollY=window.setInterval(function(){if(d.scrollContainer!=window)return void a(d.scrollContainer).scrollTop(a(d.scrollContainer).scrollTop()+f.scroll.moveY);var b=a(d.scrollContainer).scrollTop();(f.scroll.moveY>0&&b<f.scroll.maxY||f.scroll.moveY<0&&b>0)&&(a(d.scrollContainer).scrollTop(b+f.scroll.moveY),f.draggedItem.css("top",f.draggedItem.offset().top+f.scroll.moveY+1))},10),f.scroll.scrollX=window.setInterval(function(){if(d.scrollContainer!=window)return void a(d.scrollContainer).scrollLeft(a(d.scrollContainer).scrollLeft()+f.scroll.moveX);var b=a(d.scrollContainer).scrollLeft();(f.scroll.moveX>0&&b<f.scroll.maxX||f.scroll.moveX<0&&b>0)&&(a(d.scrollContainer).scrollLeft(b+f.scroll.moveX),f.draggedItem.css("left",f.draggedItem.offset().left+f.scroll.moveX+1))},10),a(e).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),f.setPos(c.pageX,c.pageY),a(document).bind("mousemove",f.swapItems),a(document).bind("mouseup",f.dropItem),d.scrollContainer!=window&&a(window).bind("wheel",f.wheel)},setPos:function(b,c){var e=c-this.offset.top,g=b-this.offset.left;d.dragBetween||(e=Math.min(this.offsetLimit.bottom,Math.max(e,this.offsetLimit.top)),g=Math.min(this.offsetLimit.right,Math.max(g,this.offsetLimit.left)));var h=this.draggedItem.offsetParent().not("body").offset();if(null!=h&&(e-=h.top,g-=h.left),d.scrollContainer==window)c-=a(window).scrollTop(),b-=a(window).scrollLeft(),c=Math.max(0,c-a(window).height()+5)+Math.min(0,c-5),b=Math.max(0,b-a(window).width()+5)+Math.min(0,b-5);else{var i=a(d.scrollContainer),j=i.offset();c=Math.max(0,c-i.height()-j.top)+Math.min(0,c-j.top),b=Math.max(0,b-i.width()-j.left)+Math.min(0,b-j.left)}f.scroll.moveX=0==b?0:b*d.scrollSpeed/Math.abs(b),f.scroll.moveY=0==c?0:c*d.scrollSpeed/Math.abs(c),this.draggedItem.css({top:e,left:g})},wheel:function(b){if(f&&d.scrollContainer!=window){var c=a(d.scrollContainer),e=c.offset();if(b=b.originalEvent,b.clientX>e.left&&b.clientX<e.left+c.width()&&b.clientY>e.top&&b.clientY<e.top+c.height()){var g=(0==b.deltaMode?1:10)*b.deltaY;c.scrollTop(c.scrollTop()+g),b.preventDefault()}}},buildPositionTable:function(){var b=[];this.getItems().not([f.draggedItem[0],f.placeHolderItem[0]]).each(function(c){var d=a(this).offset();d.right=d.left+a(this).outerWidth(),d.bottom=d.top+a(this).outerHeight(),d.elm=this,b[c]=d}),this.pos=b},dropItem:function(){if(null!=f.draggedItem){var b=f.draggedItem.attr("data-origstyle");if(f.draggedItem.attr("style",b),""==b&&f.draggedItem.removeAttr("style"),f.draggedItem.removeAttr("data-origstyle"),f.styleDragHandlers(!0),f.placeHolderItem.before(f.draggedItem),f.placeHolderItem.remove(),a("[data-droptarget], .dragSortItem").remove(),window.clearInterval(f.scroll.scrollY),window.clearInterval(f.scroll.scrollX),f.draggedItem.attr("data-origpos")!=a(e).index(f)+"-"+a(f.container).children().index(f.draggedItem)&&0==d.dragEnd.apply(f.draggedItem)){var c=f.draggedItem.attr("data-origpos").split("-"),g=a(e[c[0]].container).children().not(f.draggedItem).eq(c[1]);g.size()>0?g.before(f.draggedItem):0==c[1]?a(e[c[0]].container).prepend(f.draggedItem):a(e[c[0]].container).append(f.draggedItem)}return f.draggedItem.removeAttr("data-origpos"),f.draggedItem=null,a(document).unbind("mousemove",f.swapItems),a(document).unbind("mouseup",f.dropItem),d.scrollContainer!=window&&a(window).unbind("wheel",f.wheel),!1}},swapItems:function(b){if(null==f.draggedItem)return!1;f.setPos(b.pageX,b.pageY);for(var c=f.findPos(b.pageX,b.pageY),h=f,i=0;c==-1&&d.dragBetween&&i<e.length;i++)c=e[i].findPos(b.pageX,b.pageY),h=e[i];if(c==-1)return!1;var j=function(){return a(h.container).children().not(h.draggedItem)},k=j().not(d.itemSelector).each(function(a){this.idx=j().index(this)});return null==g||g.top>f.draggedItem.offset().top||g.left>f.draggedItem.offset().left?a(h.pos[c].elm).before(f.placeHolderItem):a(h.pos[c].elm).after(f.placeHolderItem),k.each(function(){var b=j().eq(this.idx).get(0);this!=b&&j().index(this)<this.idx?a(this).insertAfter(b):this!=b&&a(this).insertBefore(b)}),a(e).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),g=f.draggedItem.offset(),!1},findPos:function(a,b){for(var c=0;c<this.pos.length;c++)if(this.pos[c].left<a&&this.pos[c].right>a&&this.pos[c].top<b&&this.pos[c].bottom>b)return c;return-1},createDropTargets:function(){d.dragBetween&&a(e).each(function(){var b=a(this.container).find("[data-placeholder]"),c=a(this.container).find("[data-droptarget]");b.size()>0&&c.size()>0?c.remove():0==b.size()&&0==c.size()&&("td"==d.tagName?a(d.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):a(this.container).append(f.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),f.placeHolderItem.attr("data-placeholder",!0))})}};i.init(),e.push(i)}),this},a.fn.dragsort.defaults={itemSelector:"",dragSelector:"",defaultSelector:"li",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,dragZIndex:999,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}});