define(["jquery"],function(a){function b(a){return document.createElementNS(j,a)}function c(a){return(a<10?"0":"")+a}function d(a){var b=++r+"";return a?a+b:b}function e(e,h){function j(a,b){var c=m.offset(),d=/^touch/.test(a.type),e=c.left+s,f=c.top+s,j=(d?a.originalEvent.touches[0]:a).pageX-e,l=(d?a.originalEvent.touches[0]:a).pageY-f,n=Math.sqrt(j*j+l*l),q=!1;if(!b||!(n<t-v||n>t+v)){a.preventDefault();var r=setTimeout(function(){g.addClass("clockpicker-moving")},200);k&&m.append(D.canvas),D.setHand(j,l,!b,!0),i.off(o).on(o,function(a){a.preventDefault();var b=/^touch/.test(a.type),c=(b?a.originalEvent.touches[0]:a).pageX-e,d=(b?a.originalEvent.touches[0]:a).pageY-f;(q||c!==j||d!==l)&&(q=!0,D.setHand(c,d,!1,!0))}),i.off(p).on(p,function(a){i.off(p),a.preventDefault();var c=/^touch/.test(a.type),d=(c?a.originalEvent.changedTouches[0]:a).pageX-e,k=(c?a.originalEvent.changedTouches[0]:a).pageY-f;(b||q)&&d===j&&k===l&&D.setHand(d,k),"hours"===D.currentView?D.toggleView("minutes",x/2):h.autoclose&&(D.minutesView.addClass("clockpicker-dial-out"),setTimeout(function(){D.done()},x/2)),m.prepend(L),clearTimeout(r),g.removeClass("clockpicker-moving"),i.off(o)})}}var l=a(y),m=l.find(".clockpicker-plate"),q=l.find(".clockpicker-hours"),r=l.find(".clockpicker-minutes"),z=l.find(".clockpicker-am-pm-block"),A="INPUT"===e.prop("tagName"),B=A?e:e.find("input"),C=e.find(".input-group-addon"),D=this;if(this.id=d("cp"),this.element=e,this.options=h,this.isAppended=!1,this.isShown=!1,this.currentView="hours",this.isInput=A,this.input=B,this.addon=C,this.popover=l,this.plate=m,this.hoursView=q,this.minutesView=r,this.amPmBlock=z,this.spanHours=l.find(".clockpicker-span-hours"),this.spanMinutes=l.find(".clockpicker-span-minutes"),this.spanAmPm=l.find(".clockpicker-span-am-pm"),this.amOrPm="PM",h.twelvehour){var E=['<div class="clockpicker-am-pm-block">','<button type="button" class="btn btn-sm btn-default clockpicker-button clockpicker-am-button">',"AM</button>",'<button type="button" class="btn btn-sm btn-default clockpicker-button clockpicker-pm-button">',"PM</button>","</div>"].join("");a(E);a('<button type="button" class="btn btn-sm btn-default clockpicker-button am-button">AM</button>').on("click",function(){D.amOrPm="AM",a(".clockpicker-span-am-pm").empty().append("AM")}).appendTo(this.amPmBlock),a('<button type="button" class="btn btn-sm btn-default clockpicker-button pm-button">PM</button>').on("click",function(){D.amOrPm="PM",a(".clockpicker-span-am-pm").empty().append("PM")}).appendTo(this.amPmBlock)}h.autoclose||a('<button type="button" class="btn btn-sm btn-default btn-block clockpicker-button">'+h.donetext+"</button>").click(a.proxy(this.done,this)).appendTo(l),"top"!==h.placement&&"bottom"!==h.placement||"top"!==h.align&&"bottom"!==h.align||(h.align="left"),"left"!==h.placement&&"right"!==h.placement||"left"!==h.align&&"right"!==h.align||(h.align="top"),l.addClass(h.placement),l.addClass("clockpicker-align-"+h.align),this.spanHours.click(a.proxy(this.toggleView,this,"hours")),this.spanMinutes.click(a.proxy(this.toggleView,this,"minutes")),B.on("focus.clockpicker click.clockpicker",a.proxy(this.show,this)),C.on("click.clockpicker",a.proxy(this.toggle,this));var F,G,H,I,J=a('<div class="clockpicker-tick"></div>');if(h.twelvehour)for(F=1;F<13;F+=1)G=J.clone(),H=F/6*Math.PI,I=t,G.css("font-size","120%"),G.css({left:s+Math.sin(H)*I-v,top:s-Math.cos(H)*I-v}),G.html(0===F?"00":F),q.append(G),G.on(n,j);else for(F=0;F<24;F+=1){G=J.clone(),H=F/6*Math.PI;var K=F>0&&F<13;I=K?u:t,G.css({left:s+Math.sin(H)*I-v,top:s-Math.cos(H)*I-v}),K&&G.css("font-size","120%"),G.html(0===F?"00":F),q.append(G),G.on(n,j)}for(F=0;F<60;F+=5)G=J.clone(),H=F/30*Math.PI,G.css({left:s+Math.sin(H)*t-v,top:s-Math.cos(H)*t-v}),G.css("font-size","120%"),G.html(c(F)),r.append(G),G.on(n,j);if(m.on(n,function(b){0===a(b.target).closest(".clockpicker-tick").length&&j(b,!0)}),k){var L=l.find(".clockpicker-canvas"),M=b("svg");M.setAttribute("class","clockpicker-svg"),M.setAttribute("width",w),M.setAttribute("height",w);var N=b("g");N.setAttribute("transform","translate("+s+","+s+")");var O=b("circle");O.setAttribute("class","clockpicker-canvas-bearing"),O.setAttribute("cx",0),O.setAttribute("cy",0),O.setAttribute("r",2);var P=b("line");P.setAttribute("x1",0),P.setAttribute("y1",0);var Q=b("circle");Q.setAttribute("class","clockpicker-canvas-bg"),Q.setAttribute("r",v);var R=b("circle");R.setAttribute("class","clockpicker-canvas-fg"),R.setAttribute("r",3.5),N.appendChild(P),N.appendChild(Q),N.appendChild(R),N.appendChild(O),M.appendChild(N),L.append(M),this.hand=P,this.bg=Q,this.fg=R,this.bearing=O,this.g=N,this.canvas=L}f(this.options.init)}function f(a){a&&"function"==typeof a&&a()}var g,h=a(window),i=a(document),j="http://www.w3.org/2000/svg",k="SVGAngle"in window&&function(){var a,b=document.createElement("div");return b.innerHTML="<svg/>",a=(b.firstChild&&b.firstChild.namespaceURI)==j,b.innerHTML="",a}(),l=function(){var a=document.createElement("div").style;return"transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a}(),m="ontouchstart"in window,n="mousedown"+(m?" touchstart":""),o="mousemove.clockpicker"+(m?" touchmove.clockpicker":""),p="mouseup.clockpicker"+(m?" touchend.clockpicker":""),q=navigator.vibrate?"vibrate":navigator.webkitVibrate?"webkitVibrate":null,r=0,s=100,t=80,u=54,v=13,w=2*s,x=l?350:1,y=['<div class="popover clockpicker-popover">','<div class="arrow"></div>','<div class="popover-title">','<span class="clockpicker-span-hours text-primary"></span>'," : ",'<span class="clockpicker-span-minutes"></span>','<span class="clockpicker-span-am-pm"></span>',"</div>",'<div class="popover-content">','<div class="clockpicker-plate">','<div class="clockpicker-canvas"></div>','<div class="clockpicker-dial clockpicker-hours"></div>','<div class="clockpicker-dial clockpicker-minutes clockpicker-dial-out"></div>',"</div>",'<span class="clockpicker-am-pm-block">',"</span>","</div>","</div>"].join("");e.DEFAULTS={default:"",fromnow:0,placement:"bottom",align:"left",donetext:"完成",autoclose:!1,twelvehour:!1,vibrate:!0},e.prototype.toggle=function(){this[this.isShown?"hide":"show"]()},e.prototype.locate=function(){var a=this.element,b=this.popover,c=a.offset(),d=a.outerWidth(),e=a.outerHeight(),f=this.options.placement,g=this.options.align,h={};switch(b.show(),f){case"bottom":h.top=c.top+e;break;case"right":h.left=c.left+d;break;case"top":h.top=c.top-b.outerHeight();break;case"left":h.left=c.left-b.outerWidth()}switch(g){case"left":h.left=c.left;break;case"right":h.left=c.left+d-b.outerWidth();break;case"top":h.top=c.top;break;case"bottom":h.top=c.top+e-b.outerHeight()}b.css(h)},e.prototype.show=function(b){if(!this.isShown){f(this.options.beforeShow);var d=this;this.isAppended||(g=a(document.body).append(this.popover),h.on("resize.clockpicker"+this.id,function(){d.isShown&&d.locate()}),this.isAppended=!0);var e=((this.input.prop("value")||this.options.default||"")+"").split(":");if("now"===e[0]){var j=new Date(+new Date+this.options.fromnow);e=[j.getHours(),j.getMinutes()]}this.hours=+e[0]||0,this.minutes=+e[1]||0,this.spanHours.html(c(this.hours)),this.spanMinutes.html(c(this.minutes)),this.toggleView("hours"),this.locate(),this.isShown=!0,i.on("click.clockpicker."+this.id+" focusin.clockpicker."+this.id,function(b){var c=a(b.target);0===c.closest(d.popover).length&&0===c.closest(d.addon).length&&0===c.closest(d.input).length&&d.hide()}),i.on("keyup.clockpicker."+this.id,function(a){27===a.keyCode&&d.hide()}),f(this.options.afterShow)}},e.prototype.hide=function(){f(this.options.beforeHide),this.isShown=!1,i.off("click.clockpicker."+this.id+" focusin.clockpicker."+this.id),i.off("keyup.clockpicker."+this.id),this.popover.hide(),f(this.options.afterHide)},e.prototype.toggleView=function(b,c){var d=!1;"minutes"===b&&"visible"===a(this.hoursView).css("visibility")&&(f(this.options.beforeHourSelect),d=!0);var e="hours"===b,g=e?this.hoursView:this.minutesView,h=e?this.minutesView:this.hoursView;this.currentView=b,this.spanHours.toggleClass("text-primary",e),this.spanMinutes.toggleClass("text-primary",!e),h.addClass("clockpicker-dial-out"),g.css("visibility","visible").removeClass("clockpicker-dial-out"),this.resetClock(c),clearTimeout(this.toggleViewTimer),this.toggleViewTimer=setTimeout(function(){h.css("visibility","hidden")},x),d&&f(this.options.afterHourSelect)},e.prototype.resetClock=function(a){var b=this.currentView,c=this[b],d="hours"===b,e=Math.PI/(d?6:30),f=c*e,g=d&&c>0&&c<13?u:t,h=Math.sin(f)*g,i=-Math.cos(f)*g,j=this;k&&a?(j.canvas.addClass("clockpicker-canvas-out"),setTimeout(function(){j.canvas.removeClass("clockpicker-canvas-out"),j.setHand(h,i)},a)):this.setHand(h,i)},e.prototype.setHand=function(b,d,e,f){var g,h=Math.atan2(b,-d),i="hours"===this.currentView,j=Math.PI/(i||e?6:30),l=Math.sqrt(b*b+d*d),m=this.options,n=i&&l<(t+u)/2,o=n?u:t;if(m.twelvehour&&(o=t),h<0&&(h=2*Math.PI+h),g=Math.round(h/j),h=g*j,m.twelvehour?i?0===g&&(g=12):(e&&(g*=5),60===g&&(g=0)):i?(12===g&&(g=0),g=n?0===g?12:g:0===g?0:g+12):(e&&(g*=5),60===g&&(g=0)),this[this.currentView]!==g&&q&&this.options.vibrate&&(this.vibrateTimer||(navigator[q](10),this.vibrateTimer=setTimeout(a.proxy(function(){this.vibrateTimer=null},this),100))),this[this.currentView]=g,this[i?"spanHours":"spanMinutes"].html(c(g)),!k)return void this[i?"hoursView":"minutesView"].find(".clockpicker-tick").each(function(){var b=a(this);b.toggleClass("active",g===+b.html())});f||!i&&g%5?(this.g.insertBefore(this.hand,this.bearing),this.g.insertBefore(this.bg,this.fg),this.bg.setAttribute("class","clockpicker-canvas-bg clockpicker-canvas-bg-trans")):(this.g.insertBefore(this.hand,this.bg),this.g.insertBefore(this.fg,this.bg),this.bg.setAttribute("class","clockpicker-canvas-bg"));var p=Math.sin(h)*o,r=-Math.cos(h)*o;this.hand.setAttribute("x2",p),this.hand.setAttribute("y2",r),this.bg.setAttribute("cx",p),this.bg.setAttribute("cy",r),this.fg.setAttribute("cx",p),this.fg.setAttribute("cy",r)},e.prototype.done=function(){f(this.options.beforeDone),this.hide();var a=this.input.prop("value"),b=c(this.hours)+":"+c(this.minutes);this.options.twelvehour&&(b+=this.amOrPm),this.input.prop("value",b),b!==a&&(this.input.triggerHandler("change"),this.isInput||this.element.trigger("change")),this.options.autoclose&&this.input.trigger("blur"),f(this.options.afterDone)},e.prototype.remove=function(){this.element.removeData("clockpicker"),this.input.off("focus.clockpicker click.clockpicker"),this.addon.off("click.clockpicker"),this.isShown&&this.hide(),this.isAppended&&(h.off("resize.clockpicker"+this.id),this.popover.remove())},a.fn.clockpicker=function(b){var c=Array.prototype.slice.call(arguments,1);return this.each(function(){var d=a(this),f=d.data("clockpicker");if(f)"function"==typeof f[b]&&f[b].apply(f,c);else{var g=a.extend({},e.DEFAULTS,d.data(),"object"==typeof b&&b);d.data("clockpicker",new e(d,g))}})}});