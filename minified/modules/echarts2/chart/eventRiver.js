define("echarts2/chart/eventRiver",["require","./base","../layout/eventRiver","zrender2/shape/Polygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","../util/date","zrender2/tool/util","zrender2/tool/color","../chart"],function(a){function b(a,b,d,e,f){c.call(this,a,b,d,e,f);var g=this;g._ondragend=function(){g.isDragend=!0},this.refresh(e)}var c=a("./base"),d=a("../layout/eventRiver"),e=a("zrender2/shape/Polygon");a("../component/axis"),a("../component/grid"),a("../component/dataZoom");var f=a("../config");f.eventRiver={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,itemStyle:{normal:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0,position:"inside",formatter:"{b}"}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0}}}};var g=a("../util/ecData"),h=a("../util/date"),i=a("zrender2/tool/util"),j=a("zrender2/tool/color");return b.prototype={type:f.CHART_TYPE_EVENTRIVER,_buildShape:function(){var a=this.series;this.selectedMap={},this._dataPreprocessing();for(var b=this.component.legend,c=[],e=0;e<a.length;e++)if(a[e].type===this.type){a[e]=this.reformOption(a[e]),this.legendHoverLink=a[e].legendHoverLink||this.legendHoverLink;var f=a[e].name||"";if(this.selectedMap[f]=!b||b.isSelected(f),!this.selectedMap[f])continue;this.buildMark(e),c.push(this.series[e])}d(c,this._intervalX,this.component.grid.getArea()),this._drawEventRiver(),this.addShapeList()},_dataPreprocessing:function(){for(var a,b,c=this.series,d=0,e=c.length;d<e;d++)if(c[d].type===this.type){a=this.component.xAxis.getAxis(c[d].xAxisIndex||0);for(var f=0,g=c[d].data.length;f<g;f++){b=c[d].data[f].evolution;for(var i=0,j=b.length;i<j;i++)b[i].timeScale=a.getCoord(h.getNewDate(b[i].time)-0),b[i].valueScale=Math.pow(b[i].value,.8)}}this._intervalX=Math.round(this.component.grid.getWidth()/40)},_drawEventRiver:function(){for(var a=this.series,b=0;b<a.length;b++){var c=a[b].name||"";if(a[b].type===this.type&&this.selectedMap[c])for(var d=0;d<a[b].data.length;d++)this._drawEventBubble(a[b].data[d],b,d)}},_drawEventBubble:function(a,b,c){var d=this.series,f=d[b],h=f.name||"",i=f.data[c],k=[i,f],l=this.component.legend,m=l?l.getColor(h):this.zr.getColor(b),n=this.deepMerge(k,"itemStyle.normal")||{},o=this.deepMerge(k,"itemStyle.emphasis")||{},p=this.getItemStyleColor(n.color,b,c,i)||m,q=this.getItemStyleColor(o.color,b,c,i)||("string"==typeof p?j.lift(p,-.2):p),r=this._calculateControlPoints(a),s={zlevel:f.zlevel,z:f.z,clickable:this.deepQuery(k,"clickable"),style:{pointList:r,smooth:"spline",brushType:"both",lineJoin:"round",color:p,lineWidth:n.borderWidth,strokeColor:n.borderColor},highlightStyle:{color:q,lineWidth:o.borderWidth,strokeColor:o.borderColor},draggable:"vertical",ondragend:this._ondragend};s=new e(s),this.addLabel(s,f,i,a.name),g.pack(s,d[b],b,d[b].data[c],c,d[b].data[c].name),this.shapeList.push(s)},_calculateControlPoints:function(a){var b=this._intervalX,c=a.y,d=a.evolution,e=d.length;if(!(e<1)){for(var f=[],g=[],h=0;h<e;h++)f.push(d[h].timeScale),g.push(d[h].valueScale);var i=[];i.push([f[0],c]);var h=0;for(h=0;h<e-1;h++)i.push([(f[h]+f[h+1])/2,g[h]/-2+c]);for(i.push([(f[h]+(f[h]+b))/2,g[h]/-2+c]),i.push([f[h]+b,c]),i.push([(f[h]+(f[h]+b))/2,g[h]/2+c]),h=e-1;h>0;h--)i.push([(f[h]+f[h-1])/2,g[h-1]/2+c]);return i}},ondragend:function(a,b){this.isDragend&&a.target&&(b.dragOut=!0,b.dragIn=!0,b.needRefresh=!1,this.isDragend=!1)},refresh:function(a){a&&(this.option=a,this.series=a.series),this.backupShapeList(),this._buildShape()}},i.inherits(b,c),a("../chart").define("eventRiver",b),b}),define("echarts2/layout/eventRiver",["require"],function(a){function b(a,b,d){function g(a,b){var c=a.importance,d=b.importance;return c>d?-1:c<d?1:0}for(var h=4,i=0;i<a.length;i++){for(var j=0;j<a[i].data.length;j++){null==a[i].data[j].weight&&(a[i].data[j].weight=1);for(var k=0,l=0;l<a[i].data[j].evolution.length;l++)k+=a[i].data[j].evolution[l].valueScale;a[i].data[j].importance=k*a[i].data[j].weight}a[i].data.sort(g)}for(var i=0;i<a.length;i++){null==a[i].weight&&(a[i].weight=1);for(var k=0,j=0;j<a[i].data.length;j++)k+=a[i].data[j].weight;a[i].importance=k*a[i].weight}a.sort(g);for(var m=Number.MAX_VALUE,n=0,i=0;i<a.length;i++)for(var j=0;j<a[i].data.length;j++)for(var l=0;l<a[i].data[j].evolution.length;l++){var o=a[i].data[j].evolution[l].timeScale;m=Math.min(m,o),n=Math.max(n,o)}m=~~m,n=~~n;for(var p=function(){var a=n-m+1+~~b;if(a<=0)return[0];for(var c=[];a--;)c.push(0);return c}(),q=p.slice(0),r=[],s=0,t=0,i=0;i<a.length;i++)for(var j=0;j<a[i].data.length;j++){var u=a[i].data[j];u.time=[],u.value=[];for(var v,w=0,l=0;l<a[i].data[j].evolution.length;l++)v=a[i].data[j].evolution[l],u.time.push(v.timeScale),u.value.push(v.valueScale),w=Math.max(w,v.valueScale);e(u,b,m),u.y=f(q,u,function(a,b){return a.ypx[b]}),u._offset=f(p,u,function(){return h}),s=Math.max(s,u.y+w),t=Math.max(t,u._offset),r.push(u)}c(r,d,s,t)}function c(a,b,c,d){for(var e=b.height,f=d/e>.5?.5:1,g=b.y,h=(b.height-d)/c,i=0,j=a.length;i<j;i++){var k=a[i];k.y=g+h*k.y+k._offset*f,delete k.time,delete k.value,delete k.xpx,delete k.ypx,delete k._offset;for(var l=k.evolution,m=0,n=l.length;m<n;m++)l[m].valueScale*=h}}function d(a,b,c,d){if(a===c)throw new Error("x0 is equal with x1!!!");if(b===d)return function(){return b};var e=(b-d)/(a-c),f=(d*a-b*c)/(a-c);return function(a){return e*a+f}}function e(a,b,c){var e=~~b,f=a.time.length;a.xpx=[],a.ypx=[];for(var g,h=0,i=0,j=0,k=0,l=0;h<f;h++){i=~~a.time[h],k=a.value[h]/2,h===f-1?(j=i+e,l=0):(j=~~a.time[h+1],l=a.value[h+1]/2),g=d(i,k,j,l);for(var m=i;m<j;m++)a.xpx.push(m-c),a.ypx.push(g(m))}a.xpx.push(j-c),a.ypx.push(l)}function f(a,b,c){for(var d,e=0,f=b.xpx.length,g=0;g<f;g++)d=c(b,g),e=Math.max(e,d+a[b.xpx[g]]);for(g=0;g<f;g++)d=c(b,g),a[b.xpx[g]]=e+d;return e}return b});